-- User queries

-- Create a new user
-- name: CreateUser :one
INSERT INTO users (
    email, username, first_name, last_name, password_hash, role
) VALUES (
    $1, $2, $3, $4, $5, $6
) RETURNING *;

-- Get user by ID
-- name: GetUserByID :one
SELECT * FROM users WHERE id = $1;

-- Get user by email
-- name: GetUserByEmail :one
SELECT * FROM users WHERE email = $1;

-- Get user by username
-- name: GetUserByUsername :one
SELECT * FROM users WHERE username = $1;

-- Update user
-- name: UpdateUser :one
UPDATE users 
SET 
    email = COALESCE($2, email),
    username = COALESCE($3, username),
    first_name = COALESCE($4, first_name),
    last_name = COALESCE($5, last_name),
    role = COALESCE($6, role),
    is_active = COALESCE($7, is_active),
    updated_at = NOW()
WHERE id = $1
RETURNING *;

-- Delete user
-- name: DeleteUser :exec
DELETE FROM users WHERE id = $1;

-- List users with pagination
-- name: ListUsers :many
SELECT * FROM users 
ORDER BY created_at DESC 
LIMIT $1 OFFSET $2;

-- Count users
-- name: CountUsers :one
SELECT COUNT(*) as total FROM users;

-- Session queries

-- Create session
-- name: CreateSession :one
INSERT INTO sessions (
    user_id, session_token, expires_at
) VALUES (
    $1, $2, $3
) RETURNING *;

-- Get session by token
-- name: GetSessionByToken :one
SELECT * FROM sessions WHERE session_token = $1;

-- Delete session by token
-- name: DeleteSessionByToken :exec
DELETE FROM sessions WHERE session_token = $1;

-- Delete expired sessions
-- name: DeleteExpiredSessions :exec
DELETE FROM sessions WHERE expires_at < NOW();

-- Refresh token queries

-- Create refresh token
-- name: CreateRefreshToken :one
INSERT INTO refresh_tokens (
    user_id, token, expires_at
) VALUES (
    $1, $2, $3
) RETURNING *;

-- Get refresh token
-- name: GetRefreshToken :one
SELECT * FROM refresh_tokens WHERE token = $1;

-- Delete refresh token
-- name: DeleteRefreshToken :exec
DELETE FROM refresh_tokens WHERE token = $1;

-- Delete expired refresh tokens
-- name: DeleteExpiredRefreshTokens :exec
DELETE FROM refresh_tokens WHERE expires_at < NOW();